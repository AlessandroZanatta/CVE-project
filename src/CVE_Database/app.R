library(shiny)
library(shinyWidgets)

cve_better_names = cve %>%
    filter(!str_detect(cwe_name,"^DEPRECATED.*")) %>%
    mutate(cwe_name =
               case_when(
                   str_detect(cwe_name, "Memory Buffer") ~ "Buffer Overflow",
                   str_detect(cwe_name, "Cross-site") ~ "Cross-site Scripting (XSS)",
                   str_detect(cwe_name, "SQL") ~ "SQL Injection",
                   str_detect(cwe_name, "Access Controls") ~ "Access Control",
                   str_detect(cwe_name, "Input Validation") ~ "Improper Input Validation",
                   str_detect(cwe_name, "Information Exposure") ~ "Information Exposure",
                   str_detect(cwe_name, "Cryptographic Issues") ~ "Cryptographic Issues",
                   str_detect(cwe_name, "Resource Management Errors") ~ "Resource Management Errors",
                   str_detect(cwe_name, "Path Traversal") ~ "Path Traversal",
                   str_detect(cwe_name, "('Code Injection')") ~ "Code Injection",
                   str_detect(cwe_name, "Integer Overflow") ~ "Integer Overflow",
                   str_detect(cwe_name, "('OS Command Injection')") ~ "OS Command Injection",
                   str_detect(cwe_name, "('Race Condition')") ~ "Race Condition",
                   str_detect(cwe_name, "('Link Following')") ~ "Link Following",
                   str_detect(cwe_name, "('Command Injection')") ~ "Command Injection",
                   str_detect(cwe_name, "Unrestricted Upload of File") ~ "Unrestricted Upload of File",
                   str_detect(cwe_name, "Incorrect Permission Assignment for Critical") ~ "Incorrect Permission Assignment",
                   str_detect(cwe_name, "XML External Entity") ~ "XML External Entity (XXE)",
                   str_detect(cwe_name, "('Injection')") ~ "Special Elements Injection",
                   str_detect(cwe_name, "Missing Release of Resource after") ~ "Missing Release of Resource",
                   str_detect(cwe_name, "('Open Redirect')") ~ "Open Redirect",
                   str_detect(cwe_name, "Use of Externally-Controlled") ~ "Format String Vulnerability",
                   str_detect(cwe_name, "('Infinite Loop')") ~ "Infinite Loop",
                   str_detect(cwe_name, "Double Free") ~ "Use After Free (UAF)",
                   str_detect(cwe_name, "Sensitive Information in") ~ "Sensitive Information in Logs",
                   str_detect(cwe_name, "('Classic Buffer Overflow')") ~ "Classic Buffer Overflow",
                   str_detect(cwe_name, "Missing Authentication") ~ "Missing Authentication",
                   str_detect(cwe_name, "Allocation of Resources") ~  "Allocation of Resources without Limits",
                   str_detect(cwe_name, "Exposure of Resources") ~ "Exposure of Resources",
                   str_detect(cwe_name, "Improper Resource Shutdown") ~ "Improper Resource Release",
                   str_detect(cwe_name, "Weak Password Recovery Mechanism") ~ "Weak Password Recovery Mechanism",
                   str_detect(cwe_name, "Integer Underflow") ~ "Integer Underflow",
                   str_detect(cwe_name, "Improper Handling of Exceptional") ~ "Improper Handling of Exceptions",
                   str_detect(cwe_name, "Improper Check for Unusual or Exceptional Conditions") ~ "Improper Check of Exceptions",
                   str_detect(cwe_name, "Insecure Default Initialization of Resource") ~ "Insecure Initialization of Resource",
                   str_detect(cwe_name, "('CRLF Injection')") ~ "CRLF Injection",
                   str_detect(cwe_name, "Use of Cryptographically Weak Pseudo-Random Number Generator (PRNG)") ~ "Cryptographically Weak PRNG",
                   str_detect(cwe_name, "XML Injection (aka Blind XPath Injection)") ~ "Blind XPath Injection",
                   str_detect(cwe_name, "Direct Request ('Forced Browsing')") ~ "Direct Request (Forced Browsing)",
                   str_detect(cwe_name, "Authorization Bypass Through User-Controlled Key") ~ "Authorization Bypass",
                   str_detect(cwe_name, "Improper Neutralization of CRLF Sequences in HTTP Headers ('HTTP Response Splitting')") ~ "HTTP Response Splitting with CRLF",
                   str_detect(cwe_name, "Improperly Implemented Security Check for Standard") ~ "Improperly Implemented Security Check",
                   str_detect(cwe_name, "Inconsistent Interpretation of HTTP Requests ('HTTP Request Smuggling')") ~ "HTTP Request Smuggling",
                   TRUE ~ as.character(cwe_name)))

# Vulnerabilities as dictionary list
vuln_df = cve_better_names %>% 
    group_by(cwe_name, cwe_code) %>% 
    summarise(n=n(), .groups="drop_last") %>%
    filter(n > 20) %>%
    arrange(-n) %>%
    select(cwe_name, cwe_code) 

vuln_list = as.list(vuln_df)
mylist = list()
for(i in 1:length(vuln_list$cwe_code)){
    mylist[[as.character(vuln_list$cwe_name[[i]])]] = vuln_list$cwe_code[[i]]
}


# Base for Vulnerability History queries
vuln_history = cve_better_names %>%
    group_by(pub_year) %>%
    mutate(tot = n()) %>%
    ungroup() %>%
    select(cwe_name, pub_year, tot, cwe_code) %>%
    group_by(cwe_name, pub_year, tot, cwe_code) %>%
    summarise(n=n(), .groups="drop_last") %>%
    mutate(freq = n/tot) %>%
    arrange(-freq) %>%
    filter(cwe %in% vuln_df$cwe_code)


ui = fluidPage(
    titlePanel("CVE Database"),
    
    tabsetPanel(
        tabPanel("Vulnerability History",
                 sidebarLayout(
                     sidebarPanel(
                         sliderInput("vuln_history_year", h3("Year"),
                                     sep = "",
                                     min = 1999,
                                     max = 2019,
                                     value = c(1999,2019)),
                         multiInput("vuln_history_cwe", h3("Vulnerability"), 
                                     choices = mylist, selected = 119)
                     ),
                     mainPanel(
                         plotOutput("vuln_history_plot")
                     )
                 )),
        tabPanel("Vendors' CVEs",
                 sidebarLayout(
                     sidebarPanel(),
                     mainPanel(
                         tableOutput("vendor_cve_table")
                    )
                 )),
        tabPanel("Search CVEs",
                 sidebarLayout(
                     sidebarPanel(),
                     mainPanel(
                         tableOutput("search_cve_table")
                    )
                 ))
    )
)

# Define server logic required to draw a histogram
server <- function(input, output) {
    output$vuln_history_plot = renderPlot({
        
        year_start = as.integer(input$vuln_history_year[[1]])
        year_end = as.integer(input$vuln_history_year[[2]])
        cwe = input$vuln_history_cwe
        
        if(length(cwe) > 0){
            vuln_history %>%
                filter(pub_year >= year_start, pub_year <= year_end, cwe_code %in% cwe) %>%
                ggplot(aes(pub_year, freq, color=cwe_name, group=cwe_name)) + 
                geom_line(size=0.9) +
                labs(title = "Threats changes over the 1999-2019 period",
                     x = "Year", 
                     y = "Percentage of CVEs") + 
                facet_wrap(c("cwe_name")) + 
                theme(plot.title = plot_title,
                      axis.title.x = title_x,
                      axis.text.x = element_text(size=8, angle=90),
                      panel.grid.major = element_blank(), 
                      legend.position = "none",
                      strip.text.x = element_text(size = 11)) + 
                scale_y_continuous(labels = percent)
        }
    })
}


# Run the application
#app = shinyApp(ui = ui, server = server)
# runApp(app, port=1337)
shinyApp(ui = ui, server = server)
