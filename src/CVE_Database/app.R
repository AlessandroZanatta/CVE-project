library(shiny)
library(shinyWidgets)

# VULNERABILITIES HISTORY

cve_better_names = cve %>%
    filter(!str_detect(cwe_name,"^DEPRECATED.*")) %>%
    mutate(cwe_name =
               case_when(
                   str_detect(cwe_name, "Memory Buffer") ~ "Buffer Overflow",
                   str_detect(cwe_name, "Cross-site") ~ "Cross-site Scripting (XSS)",
                   str_detect(cwe_name, "SQL") ~ "SQL Injection",
                   str_detect(cwe_name, "Access Controls") ~ "Access Control",
                   str_detect(cwe_name, "Input Validation") ~ "Improper Input Validation",
                   str_detect(cwe_name, "Information Exposure") ~ "Information Exposure",
                   str_detect(cwe_name, "Cryptographic Issues") ~ "Cryptographic Issues",
                   str_detect(cwe_name, "Resource Management Errors") ~ "Resource Management Errors",
                   str_detect(cwe_name, "Path Traversal") ~ "Path Traversal",
                   str_detect(cwe_name, "('Code Injection')") ~ "Code Injection",
                   str_detect(cwe_name, "Integer Overflow") ~ "Integer Overflow",
                   str_detect(cwe_name, "('OS Command Injection')") ~ "OS Command Injection",
                   str_detect(cwe_name, "('Race Condition')") ~ "Race Condition",
                   str_detect(cwe_name, "('Link Following')") ~ "Link Following",
                   str_detect(cwe_name, "('Command Injection')") ~ "Command Injection",
                   str_detect(cwe_name, "Unrestricted Upload of File") ~ "Unrestricted Upload of File",
                   str_detect(cwe_name, "Incorrect Permission Assignment for Critical") ~ "Incorrect Permission Assignment",
                   str_detect(cwe_name, "XML External Entity") ~ "XML External Entity (XXE)",
                   str_detect(cwe_name, "('Injection')") ~ "Special Elements Injection",
                   str_detect(cwe_name, "Missing Release of Resource after") ~ "Missing Release of Resource",
                   str_detect(cwe_name, "('Open Redirect')") ~ "Open Redirect",
                   str_detect(cwe_name, "Use of Externally-Controlled") ~ "Format String Vulnerability",
                   str_detect(cwe_name, "('Infinite Loop')") ~ "Infinite Loop",
                   str_detect(cwe_name, "Double Free") ~ "Use After Free (UAF)",
                   str_detect(cwe_name, "Sensitive Information in") ~ "Sensitive Information in Logs",
                   str_detect(cwe_name, "('Classic Buffer Overflow')") ~ "Classic Buffer Overflow",
                   str_detect(cwe_name, "Missing Authentication") ~ "Missing Authentication",
                   str_detect(cwe_name, "Allocation of Resources") ~  "Allocation of Resources without Limits",
                   str_detect(cwe_name, "Exposure of Resources") ~ "Exposure of Resources",
                   str_detect(cwe_name, "Improper Resource Shutdown") ~ "Improper Resource Release",
                   str_detect(cwe_name, "Weak Password Recovery Mechanism") ~ "Weak Password Recovery Mechanism",
                   str_detect(cwe_name, "Integer Underflow") ~ "Integer Underflow",
                   str_detect(cwe_name, "Improper Handling of Exceptional") ~ "Improper Handling of Exceptions",
                   str_detect(cwe_name, "Improper Check for Unusual or Exceptional Conditions") ~ "Improper Check of Exceptions",
                   str_detect(cwe_name, "Insecure Default Initialization of Resource") ~ "Insecure Initialization of Resource",
                   str_detect(cwe_name, "('CRLF Injection')") ~ "CRLF Injection",
                   str_detect(cwe_name, "Use of Cryptographically Weak Pseudo-Random Number Generator (PRNG)") ~ "Cryptographically Weak PRNG",
                   str_detect(cwe_name, "XML Injection (aka Blind XPath Injection)") ~ "Blind XPath Injection",
                   str_detect(cwe_name, "Direct Request ('Forced Browsing')") ~ "Direct Request (Forced Browsing)",
                   str_detect(cwe_name, "Authorization Bypass Through User-Controlled Key") ~ "Authorization Bypass",
                   str_detect(cwe_name, "Improper Neutralization of CRLF Sequences in HTTP Headers ('HTTP Response Splitting')") ~ "HTTP Response Splitting with CRLF",
                   str_detect(cwe_name, "Improperly Implemented Security Check for Standard") ~ "Improperly Implemented Security Check",
                   str_detect(cwe_name, "Inconsistent Interpretation of HTTP Requests ('HTTP Request Smuggling')") ~ "HTTP Request Smuggling",
                   TRUE ~ as.character(cwe_name)))

# Vulnerabilities as dictionary list
vuln_df = cve_better_names %>% 
    group_by(cwe_name, cwe_code) %>% 
    summarise(n=n(), .groups="drop_last") %>%
    filter(n > 20) %>%
    arrange(-n) %>%
    select(cwe_name, cwe_code) 

vuln_list = as.list(vuln_df)
mylist = list()
for(i in 1:length(vuln_list$cwe_code)){
    mylist[[as.character(vuln_list$cwe_name[[i]])]] = vuln_list$cwe_code[[i]]
}


# Base for Vulnerability History queries
vuln_history = cve_better_names %>%
    group_by(pub_year) %>%
    mutate(tot = n()) %>%
    ungroup() %>%
    select(cwe_name, pub_year, tot, cwe_code) %>%
    group_by(cwe_name, pub_year, tot, cwe_code) %>%
    summarise(n=n(), .groups="drop_last") %>%
    mutate(freq = n/tot) %>%
    arrange(-freq) %>%
    filter(cwe_code %in% vuln_df$cwe_code)


# VENDOR CVEs IN THE YEARS



# SEARCH CVEs

# by vendor 
cve_number = 10

# all vendors
vendors_with_products = vendor_product %>%
    distinct(vendor)

vendors_more_then_n_cves = vendors %>%
    inner_join(vendors_with_products, by = "vendor") %>%
    group_by(vendor) %>%
    arrange(vendor) %>%
    mutate(n = n()) %>%
    ungroup() %>%
    filter(n > cve_number) %>%
    select(-n)

vendors_index = vendors_more_then_n_cves %>%
    group_by(vendor) %>%
    summarise(n = n(), .groups = "drop_last") %>%
    select(-n) %>%
    mutate(vendor_index = row_number())

# Products indexing
products_index = products %>%
    full_join(products %>%
                  group_by(vulnerable_product) %>%
                  summarise(n = n(), .groups = "drop_last") %>%
                  select(-n) %>%
                  mutate(product_index = row_number()), by = "vulnerable_product") %>%
    inner_join(vendor_product, by = c("vulnerable_product" = "product")) %>%
    inner_join(vendors_index, by = "vendor")


vendors_cve = vendors_more_then_n_cves %>%
    inner_join(products_index, by = c("code","vendor")) %>%
    inner_join(cve_better_names, by = "code") %>%
    filter(cwe_code %in% vuln_df$cwe_code) %>%
    mutate(publication_year = as.integer(pub_year)) %>%
    unite(pub_date, pub_day, pub_month, pub_year, sep="-") %>%
    rename(product = vulnerable_product) %>%
    mutate(
        # pub_date = dmy(pub_date), # removed as dates are not shown correctly in outputTable outputs
        vendor = str_to_sentence(vendor),
        product = str_to_title(str_replace_all(product, "_", " ")))

vendor_list = as.list(vendors_cve %>% select(vendor, vendor_index))
vendors_index_aslist = list()
for(i in 1:length(vendor_list$vendor)){
    vendors_index_aslist[[as.character(vendor_list$vendor[[i]])]] = vendor_list$vendor_index[[i]]
}


# by vulnerability

vulns = vendors_cve %>%
    distinct(cwe_name) %>%
    arrange(cwe_name) %>% 
    rename(Vulnerability = cwe_name)


ui = fluidPage(
    titlePanel("CVE Database"),
    
    tabsetPanel(
        tabPanel("Vulnerability History",
                 sidebarLayout(
                     sidebarPanel(
                         sliderInput(
                             "vuln_history_year", 
                             h3("Year"),
                             sep = "",
                             min = 1999,
                             max = 2019,
                             value = c(1999,2019)),
                         multiInput("vuln_history_cwe", h3("Vulnerability"), 
                                     choices = mylist, selected = 119)
                     ),
                     mainPanel(
                         plotOutput("vuln_history_plot")
                     )
                 )),
        tabPanel("Vendors CVEs in the time",
                    
                 
                 
                 
                 
                 ),
        tabPanel("Search CVEs",
                 sidebarLayout(
                     sidebarPanel(
                         tabsetPanel(
                             id = "search_tabs",
                             tabPanel("By Vulnerability type",
                                      value = "by_vulnerability",
                                      sliderInput(
                                          "vuln_type_year", 
                                          h3("Year"),
                                          sep = "",
                                          min = 1999,
                                          max = 2019,
                                          value = c(1999,2019)),
                                      selectizeInput(
                                          "vuln_type_vulntype",
                                          h3("Vulnerability"),
                                          choices = vulns),
                                      awesomeCheckboxGroup(
                                          "vuln_search_checkbox",
                                          h3("Columns"), 
                                          choices = list("Vendor" = "Vendor",
                                                         "Publication Date" = "Publication date",
                                                         "Summary" = "Summary", 
                                                         "Attack Vector" = "Attack Vector",
                                                         "Attack Complexity" = "Attack Complexity",
                                                         "Impacts" = "Impacts"),
                                          selected = c("Publication date"))
                             ),
                             tabPanel("By Vendor",
                                      value = "by_vendor",
                                      sliderInput(
                                          "vendor_cve_year",
                                          h3("Year"),
                                          sep = "",
                                          min = 1999,
                                          max = 2019,
                                          value = c(1999,2019)),
                                      selectizeInput(
                                          "vendor_cve_vendor",
                                          h3("Vendors"),
                                          choices = vendors_index_aslist,
                                          selected = 1),
                                      uiOutput("vendor_cve_product_ui_render"),
                                      awesomeCheckboxGroup(
                                          "vendor_search_checkbox",
                                          h3("Columns"), 
                                          choices = list("Publication Date" = "Publication date",
                                                         "Summary" = "Summary", 
                                                         "Attack Vector" = "Attack Vector",
                                                         "Attack Complexity" = "Attack Complexity",
                                                         "Impacts" = "Impacts"),
                                          selected = c("Publication date", "Impacts"))
                         )
                     )),
                     mainPanel(
                         tableOutput("search_cve_table")
                     )
                 ))
    )
)

# Define server logic required to draw a histogram
server <- function(input, output) {
    output$vuln_history_plot = renderPlot({
        
        year_start = as.integer(input$vuln_history_year[[1]])
        year_end = as.integer(input$vuln_history_year[[2]])
        cwe = input$vuln_history_cwe
        
        if(length(cwe) > 0){
            vuln_history %>%
                filter(pub_year >= year_start, pub_year <= year_end, cwe_code %in% cwe) %>%
                ggplot(aes(pub_year, freq, color=cwe_name, group=cwe_name)) + 
                geom_line(size=0.9) +
                labs(title = str_c("Threats changes over the ", as.character(year_start) , "-", as.character(year_end), " period"),
                     x = "Year", 
                     y = "Percentage of CVEs") + 
                facet_wrap(c("cwe_name")) + 
                theme(plot.title = plot_title,
                      axis.title.x = title_x,
                      axis.text.x = element_text(size=8, angle=90),
                      panel.grid.major = element_blank(), 
                      legend.position = "none",
                      strip.text.x = element_text(size = 11)) + 
                scale_y_continuous(labels = percent)
        }
    })
    
    
    output$vendor_cve_product_ui_render = renderUI({
        
        selected_vendor = as.integer(input$vendor_cve_vendor)
        
        if(!is.na(input$vendor_cve_vendor)){
            
            product_list = vendors_cve %>%
                filter(vendor_index == selected_vendor) %>%
                select(product, product_index) %>%
                distinct(product, product_index)
            
            product_list = as.list(product_list)
            prodlist = list()
            prodlist[["All"]] = 0
            for(i in 1:length(product_list$product)){
                prodlist[[as.character(product_list$product[[i]])]] = product_list$product_index[[i]]
            }
            
            
            selectInput("vendor_cve_product", 
                        h3("Products"),
                        choices = prodlist,
                        selected = 0)
        }
    })
    
    output$search_cve_table = renderTable({
        
        tabs = input$search_tabs
        
        if(tabs == "by_vendor"){
            year_start = as.integer(input$vendor_cve_year[[1]])
            year_end = as.integer(input$vendor_cve_year[[2]])
            selected_vendor = as.integer(input$vendor_cve_vendor)
            selected_product = as.integer(input$vendor_cve_product)
            checkbox = input$vendor_search_checkbox
            
            table = vendors_cve %>%
                filter(vendor_index == selected_vendor, 
                       publication_year >= year_start,
                       publication_year <= year_end) %>%
                rename(CVE = code,
                       `Publication date` = pub_date, 
                       CVSS = cvss,
                       Vulnerability = cwe_name,
                       Product = product,
                       `Attack Complexity` = access_complexity,
                       `Attack Vector` = access_vector,
                       Summary = summary,
                       `Impact Availability` = impact_availability,
                       `Impact Confidentiality` = impact_confidentiality,
                       `Impact Integrity` = impact_integrity)
            
            if(selected_product != 0){
                table = table %>%
                    filter(product_index == selected_product)
            }
            
            if("Impacts" %in% checkbox){
                checkbox = head(checkbox, -1)
                checkbox = c(checkbox, "Impact Availability", "Impact Confidentiality", "Impact Integrity")
            }
            
            if(selected_vendor == 0){
                columns = c("CVE", "Product", "CVSS", "Vulnerability", checkbox)
            } else {
                columns = c("CVE", "CVSS", "Vulnerability", checkbox)
            }
            
            table = table %>%
                select(columns) %>%
                arrange(CVE)
            
            table
        } else {
            
            year_start = as.integer(input$vuln_type_year[[1]])
            year_end = as.integer(input$vuln_type_year[[2]])
            vulnerability = input$vuln_type_vulntype
            checkbox = input$vuln_search_checkbox
            
            table = vendors_cve %>%
                filter(cwe_name == vulnerability, 
                       publication_year >= year_start,
                       publication_year <= year_end) %>%
                rename(CVE = code,
                       Vendor = vendor,
                       `Publication date` = pub_date, 
                       CVSS = cvss,
                       Vulnerability = cwe_name,
                       Product = product,
                       `Attack Complexity` = access_complexity,
                       `Attack Vector` = access_vector,
                       Summary = summary,
                       `Impact Availability` = impact_availability,
                       `Impact Confidentiality` = impact_confidentiality,
                       `Impact Integrity` = impact_integrity)
            
            if("Impacts" %in% checkbox){
                checkbox = head(checkbox, -1)
                checkbox = c(checkbox, "Impact Availability", "Impact Confidentiality", "Impact Integrity")
            }
            
            if("Vendor" %in% checkbox){
                checkbox = checkbox[!checkbox %in% "Vendor"]
                checkbox = c("Vendor", "Product", checkbox)
            }
            
            columns = c("CVE", "CVSS", checkbox)
            table = table %>%
                select(columns) %>%
                arrange(CVE)
            
            table
        }
    })
    
}


# Run the application
# app = shinyApp(ui = ui, server = server)
# runApp(app, port = 1337)
shinyApp(ui = ui, server = server)
