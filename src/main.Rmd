---
title: "Common Vulnerabilities and Exposures Analysis"
author: "Alessandro Zanatta"
output:
  ioslides_presentation: 
    css: styles.css
    widescreen: true
---

```{r setup, include=FALSE}
require("knitr")
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
opts_knit$set(root.dir = "C:/Users/aless/Documents/Universita/Secondo_anno/secondo_semestre/data_science/CVE_Project")
```

```{r, echo=FALSE, warning=FALSE}
library(tibble)
library(tidyr)
library(dplyr)
library(ggplot2)
library(showtext)
library(forcats)
library(stringr)
library(RColorBrewer)

# Load fonts
font_add("Montserrat",
    regular = "C:/Users/aless/AppData/Local/Microsoft/Windows/Fonts/Montserrat-Regular.ttf",
    bold = "C:/Users/aless/AppData/Local/Microsoft/Windows/Fonts/Montserrat-Bold.ttf")
showtext_auto()
```

```{r, echo=FALSE}

# Set working directory
setwd("C:/Users/aless/Documents/Universita/Secondo_anno/secondo_semestre/data_science/CVE_Project")

# Mitre dataset is very heavy. This option is used to avoid knitting the mitre dataset every time,
# effectively saving a LOT of rendering/computing time. 
using_mitre = FALSE 

# ================== #
# ===== Import ===== #
# ================== #

# NA's are simply blanks usually, so use na.string=c("", " ", "NA") will properly import datasets

# NVD dataset
if(using_mitre){
  all_cve = read.csv("datasets/mitre/allitems.csv", na.strings=c(""," ","NA"))
}

# Kaggle datasets
cve = read.csv("datasets/kaggle/cve.csv", na.strings=c(""," ","NA"))
products = read.csv("datasets/kaggle/products.csv", na.strings=c(""," ","NA"))
vendor_product = read.csv("datasets/kaggle/vendor_product.csv", na.strings=c(""," ","NA"))
vendors = read.csv("datasets/kaggle/vendors.csv", na.strings=c(""," ","NA"))

# Pretty view

# View(all_cve)
# View(cve)
# View(products)
# View(vendor_product)
# View(vendors)
```

```{r, echo=FALSE}
# ================== #
# ====== Tidy ====== #
# ================== #

if(using_mitre){
# We can see that the dataset from MITRE contains a header that is not related to the dataset.
# Column names are also not correct. These are stored in the header we just mentioned.
# We should also note that rows are the CVE codes. Let's make them being the first column instead.

# Delete the first 9 rows
all_cve = all_cve %>%
  slice(10:n())

# Change column names
all_cve = all_cve %>%
  rename("Status" = "CVE.Version.20061101") %>%
  rename("Description" = "X") %>%
  rename("References" = "X.1") %>%
  rename("Phase" = "X.2") %>%
  rename("Votes" = "X.3") %>%
  rename("Comments" = "X.4")

# Make the CVE code a column in the dataset
all_cve = rownames_to_column(all_cve, "Code")

# View(all_cve)
}


# We can also notice that there is a redundant column in the vendor's product dataset. 
# It is basically a duplicate of the row number, so we can simply remove it.

# Remove redundant column
vendor_product = vendor_product %>% select(-X)

# Datasets are now clean and we can start the analysis.
```

## Introduction

1. What are the Common Vulnerabilities and Exposures (CVE)?
1. What is the Common Vulnerability Scoring System (CVSS)?

```{r, out.width = '70%', fig.align='center', echo=FALSE}
knitr::include_graphics("C:/Users/aless/Documents/Universita/Secondo_anno/secondo_semestre/data_science/CVE_Project/src/img/cvebanner.png")
```

## Common Vulnerabilities and Exposures

**CVE**s is a list of **computer security problems** and threats maintained by MITRE. The list contains both vulnerabilities and exposures. 

Following the MITRE's terminology, these are *different*:

> A **vulnerability** is a weakness in the computational logic (e.g. code) found in software and some hardware components that, when exploited, results in a negative impact to confidentiality, integrity, *or* availability.
>
> An **exposure** is a system configuration issue or a mistake in software that allows access to information or capabilities that can be used by a hacker as a stepping-stone into a system or network.

## Common Vulnerability Scoring System

The **CVSS** is an open framework for communicating the characteristics and severity of software vulnerabilities.

The most common use of CVSS is calculating the **severity** of vulnerabilities discovered on one's systems. The *National Vulnerability Database* (NVD) provides CVSS scores for almost **all** known vulnerabilities. 

CVSS consists of three metric groups: Base, Temporal, and Environmental. The Base metrics produce a score ranging from 0 to 10, which can then be modified by scoring the Temporal and Environmental metrics.

```{r, out.width = '100%', fig.align='center', echo=FALSE}
knitr::include_graphics("C:/Users/aless/Documents/Universita/Secondo_anno/secondo_semestre/data_science/CVE_Project/src/img/cvss.png")
```

## Analysis

> How are the CVSS scores distributed?

```{r}

cve %>%
  # Cut into 10 classes, (0,1] , (1,2] , ... , (9,10]
  mutate(cvss = cut(cvss, breaks=10)) %>% 
  group_by(cvss) %>%
  summarise(n=n(), .groups="drop_last") %>% 
ggplot(aes(cvss, n, fill=cvss)) +
  geom_bar(position="dodge", stat="identity") +
  theme_minimal() + 
  # manually change colors to have a nice gradient
  scale_fill_manual(values=c("#49B063","#84B25C","#A1B459","#CDB654","#F9C74F",  
                             "#F9B74E","#F9A64D","#F9844A", "#F96347", "#F94144")) +
  labs(title="Threat Severity Distribution", 
       subtitle="Analyze threat severity using CVSS", 
       x = "Severity (CVSS)", 
       y = "Number of cases") +
  guides(fill = FALSE) + 
  theme(text = element_text(family = "Montserrat"),
        plot.title = element_text(size=25),
        axis.title.x = element_text(size=16),
        axis.title.y = element_text(size=16),
        axis.text.x = element_text(size=13), 
        axis.text.y = element_text(size=13),) + 
  scale_x_discrete(breaks=waiver(), # rename labels 
                   labels=c("(0,1]","(1,2]","(2,3]","(3,4]","(4,5]","(5,6]","(6,7]","(7,8]","(8,9]","(9,10]"))  

```

## Analysis

> What is the impact on confidentiality, availability and integrity?

```{r}

cve %>%
  filter(!is.na(impact_availability), # filter out NA values
         !is.na(impact_confidentiality), 
         !is.na(impact_integrity)) %>%
  # date is in format "yyyy-mm-dd hh:mm:ss"
  separate(pub_date, into=c("pub_date", "pub_hour"), sep=" ") %>% 
  # retrieve the year from it
  separate(pub_date, into=c("pub_year", "pub_month", "pub_day"), sep="-") %>% 
  # select what we need
  select(pub_year, impact_availability, impact_confidentiality, impact_integrity) %>% 
  rename(Availability=impact_availability, Confidentiality=impact_confidentiality, Integrity=impact_integrity) %>%
  # gather values in one column
  pivot_longer(c(Availability, Confidentiality, Integrity), names_to="type", values_to="impact") %>% 
  group_by(pub_year, type, impact) %>%
  summarise(n=n(), .groups="drop_last") %>%
  mutate(freq=n/sum(n)) %>% # compute frequency
  rename(Impact=impact) %>% # rename for plotting

ggplot(aes(pub_year, freq, color=Impact, group=Impact)) + 
  geom_line(size=0.9) +
  labs(title = "Impact of CVEs in the 1999-2019 period",
       x = "Year") + 
  facet_wrap(c("type"), ncol = 3) + 
  theme(text = element_text(family = "Montserrat"),
        plot.title = element_text(size=25),
        axis.title.x = element_text(size=16),
        axis.text.x = element_text(size=8, angle=90),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        strip.text.x = element_text(size = 11)) + 
  # need to have less labels, rename some to empty string
  scale_x_discrete(breaks=waiver(), 
                   labels=c("1999","","","","2003","","", "", "2007", "", "", "", "2011", "", "", "", "2015", "", "", "", "2019"))

```

## Analysis - 3

> What are the most common/exploited vulnerabilities?

```{r}

top_cwe = cve %>%
  select(cwe_name) %>%
  group_by(cwe_name) %>%
  summarise(n = n(), .groups="drop_last") %>%
  arrange(-n)
  
top = 22

top_n_cwe = top_cwe %>%
  head(top) %>%  
  # add the "Other" row, as the count of all remaining CVEs
  add_row(cwe_name = "Other", 
          n = sum(top_cwe %>% slice(top+1:n()) %>% select(n))) %>% 
  arrange(-n)

# Some names are terribly long (10+ words), hence i manually
# rename some to have a better description of the vulnerability
top_n_cwe$cwe_name = c("Other",
                        "Buffer overflow",
                        "Cross-site Scripting (XSS)",
                        "Improper Input Validation",
                        "Information Exposure",
                        "Access Control",
                        "SQL Injection",
                        "Path Traversal",
                        "Resource Management Errors",
                        "Cryptographic Issues",
                        "Code Injection",
                        "Cross-Site Request Forgery (CSRF)",
                        "Out-of-bounds read",
                        "Improper Authentication",
                        "Improper Access Control",
                        "Numeric Errors",
                        "Use After Free",
                        "Integer Overflow", 
                        "NULL pointer Dereference",
                        "Credentials Management",
                        "Out-of-bounds Write",
                        "OS Command Injection",
                        "Race Condition")

top_n_cwe %>%
  # reorder factor based on n (descending). This is only needed for plotting
  mutate(cwe_name = fct_reorder(cwe_name, n)) %>% 
  ggplot(aes(cwe_name, n, fill=n)) +
  coord_flip() +
  guides(fill=FALSE) +
  geom_col() +
  labs(title = "Most common vulnerabilities",
       subtitle = "Based on Common Weaknesses Enumeration (CWE) codes",
       x = "CWE description",
       y = "Number of cases") + 
  theme(text = element_text(family = "Montserrat"),
        plot.title = element_text(size=22),
        axis.title.x = element_text(size=16),
        axis.text.x = element_text(size=11), 
        legend.position = "none", 
        axis.title.y=element_blank(),
        strip.text.x = element_text(size = 12)) +
  scale_fill_gradientn(colours=c("#f9c74f","#90be6d","#4d908e","#577590","#277da1"))
  
```

## Analysis - 4

> How security threats have changed over time?

```{r}

cve %>%
  

```


## Analysis - 5

> What are the most used words in the CVE descriptions?


```{r}
# We use the MITRE dataset for this one, analyzing the description as text
if(using_mitre){
  
}

```

## Analysis - 6

> Which vendors have the most CVEs?

```{r}

vendors %>%
  group_by(vendor) %>%
  summarise(n=n(), .groups="drop_last") %>%
  arrange(-n) %>%
  head(16) %>%
  mutate(vendor = str_to_sentence(vendor)) %>%
  mutate(vendor = fct_reorder(vendor, n)) %>%
ggplot(aes(vendor, n, fill = n)) +
  geom_col() + 
  guides(fill = FALSE) +
  coord_flip() +
  theme_minimal() + 
  scale_fill_gradient(low="#f7b538",high="#c32f27")

```


## Reference

[Kaggle](https://www.kaggle.com/andrewkronser/cve-common-vulnerabilities-and-exposures/data)

[MITRE](https://cve.mitre.org/data/downloads/index.html)

[National Vulnerability Database](https://nvd.nist.gov)

