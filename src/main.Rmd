---
title: "Common Vulnerabilities and Exposures Analysis"
author: "Alessandro Zanatta"
output:
  ioslides_presentation: 
    css: styles.css
    widescreen: true
---

```{r setup, include=FALSE}
require("knitr")
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
opts_knit$set(root.dir = "C:/Users/aless/Documents/Universita/Secondo_anno/secondo_semestre/data_science/CVE_Project")
```

```{r, echo=FALSE, warning=FALSE}
library(ggplot2)
library(forcats)
library(stringr)
library(scales)
library(lubridate)
library(tidyverse)
library(tidytext)
library(viridis)
```

```{r, echo=FALSE}

# Set working directory
base_path = "C:/Users/aless/Documents/Universita/Secondo_anno/secondo_semestre/data_science/CVE_Project" # change this if needed
setwd(base_path)

# Mitre dataset is very heavy. This option is used to avoid knitting the mitre dataset every time,
# effectively saving a LOT of rendering/computing time. 
using_mitre = FALSE

# ================== #
# ===== Import ===== #
# ================== #

# NA's are simply blanks usually, so use na.string=c("", " ", "NA") will properly import datasets

# NVD dataset
if(using_mitre){
  all_cve = read.csv("datasets/mitre/allitems.csv", na.strings=c(""," ","NA"), header=FALSE)
}

# Kaggle datasets
cve = read.csv("datasets/kaggle/cve.csv", na.strings=c(""," ","NA"))
products = read.csv("datasets/kaggle/products.csv", na.strings=c(""," ","NA"))
vendor_product = read.csv("datasets/kaggle/vendor_product.csv", na.strings=c(""," ","NA"))
vendors = read.csv("datasets/kaggle/vendors.csv", na.strings=c(""," ","NA"))

# Pretty view

# View(all_cve)
# View(cve)
# View(products)
# View(vendor_product)
# View(vendors)
```

```{r, echo=FALSE}
# ================== #
# ====== Tidy ====== #
# ================== #

if(using_mitre){
# We can see that the dataset from MITRE contains a header that is not related to the dataset.
# Column names are also not correct. These are stored in the header we just mentioned.

# Delete the first 10 rows
all_cve = all_cve %>%
  slice(11:n())

# Change column names
all_cve = all_cve %>%
  rename("Code" = "V1") %>%
  rename("Status" = "V2") %>%
  rename("Description" = "V3") %>%
  rename("References" = "V4") %>%
  rename("Phase" = "V5") %>%
  rename("Votes" = "V6") %>%
  rename("Comments" = "V7")

# View(all_cve)
}


# We can also notice that there is a redundant column in the vendor's product dataset. 
# It is basically a duplicate of the row number, so we can simply remove it.

# Remove redundant column
vendor_product = vendor_product %>% select(-X)

# cve and vendors have a X col name for the CVE codes
cve = cve %>% rename(code = X)
vendors = vendors %>% rename(code = X)

# products has a cve-id column for the CVE codes
products = products %>% rename(code = cve_id)

# cve also has dates in a way we cannot really use it. Split the data into year, month, day, ...
cve = cve %>%
  # date is in format "yyyy-mm-dd hh:mm:ss"
  separate(pub_date, into=c("pub_date", "pub_hour"), sep=" ") %>% 
  # retrieve the year from it
  separate(pub_date, into=c("pub_year", "pub_month", "pub_day"), sep="-") %>% 
  select(code,pub_year, pub_month, cvss, cwe_code, cwe_name, summary, access_authentication, access_complexity, access_vector, impact_availability, impact_confidentiality, impact_integrity)

# Datasets are now clean and we can start the analysis.
```

## Introduction

1. What are the Common Vulnerabilities and Exposures (CVE)?
1. What is the Common Vulnerability Scoring System (CVSS)?

```{r, out.width = '70%', fig.align='center', echo=FALSE}
knitr::include_graphics(str_c(base_path,"src/img/cvebanner.png", sep="/"))
```

## Common Vulnerabilities and Exposures

**CVE**s is a list of **computer security problems** and threats maintained by MITRE. The list contains both vulnerabilities and exposures. 

Following the MITRE's terminology, these are *different*:

> A **vulnerability** is a weakness in the computational logic (e.g. code) found in software and some hardware components that, when exploited, results in a negative impact to confidentiality, integrity, *or* availability.
>
> An **exposure** is a system configuration issue or a mistake in software that allows access to information or capabilities that can be used by a hacker as a stepping-stone into a system or network.

## Common Vulnerability Scoring System

The **CVSS** is an open framework for communicating the characteristics and severity of software vulnerabilities.

The most common use of CVSS is calculating the **severity** of vulnerabilities discovered on one's systems. The *National Vulnerability Database* (NVD) provides CVSS scores for almost **all** known vulnerabilities. 

CVSS consists of three metric groups: Base, Temporal, and Environmental. The Base metrics produce a score ranging from 0 to 10, which can then be modified by scoring the Temporal and Environmental metrics.

```{r, out.width = '100%', fig.align='center', echo=FALSE}
knitr::include_graphics(str_c(base_path,"src/img/cvss.png", sep="/"))
```

## Analysis - 1

> How are the CVSS scores distributed?

```{r}

cve %>%
  # Cut into 10 classes, (0,1] , (1,2] , ... , (9,10]
  mutate(cvss = cut(cvss, breaks=10)) %>% 
  group_by(cvss) %>%
  summarise(n=n(), .groups="drop_last") %>% 
ggplot(aes(cvss, n, fill=cvss)) +
  geom_bar(position="dodge", stat="identity") +
  theme_minimal() + 
  # manually change colors to have a nice gradient
  scale_fill_manual(values=c("#49B063","#84B25C","#A1B459","#CDB654","#F9C74F",  
                             "#F9B74E","#F9A64D","#F9844A", "#F96347", "#F94144")) +
  labs(title="Threat Severity Distribution", 
       subtitle="Analyze threat severity using CVSS", 
       x = "Severity (CVSS)", 
       y = "Number of cases") +
  guides(fill = FALSE) + 
  theme(plot.title = element_text(size=25),
        axis.title.x = element_text(size=16),
        axis.title.y = element_text(size=16),
        axis.text.x = element_text(size=13), 
        axis.text.y = element_text(size=13),) + 
  scale_x_discrete(breaks=waiver(), # rename labels 
                   labels=c("(0,1]","(1,2]","(2,3]","(3,4]","(4,5]","(5,6]","(6,7]","(7,8]","(8,9]","(9,10]"))

```

## Analysis - 2

> What is the impact on confidentiality, availability and integrity?

```{r}

cve %>%
  filter(!is.na(impact_availability), # filter out NA values
         !is.na(impact_confidentiality), 
         !is.na(impact_integrity)) %>%
  # select what we need
  select(pub_year, pub_month, impact_availability, impact_confidentiality, impact_integrity) %>% 
  rename(Availability=impact_availability, Confidentiality=impact_confidentiality, Integrity=impact_integrity) %>%
  # gather values in one column
  pivot_longer(c(Availability, Confidentiality, Integrity), names_to="type", values_to="impact") %>% 
  group_by(pub_year, type, impact) %>%
  summarise(n=n(), .groups="drop_last") %>%
  mutate(freq=n/sum(n)) %>% # compute frequency
  rename(Impact=impact) %>% # rename for plotting
ggplot(aes(pub_year, freq, color=Impact, group=Impact)) + 
  geom_line(size=0.9) +
  labs(title = "Impact of CVEs in the 1999-2019 period",
       x = "Year") + 
  facet_wrap(c("type"), ncol = 3) + 
  theme(plot.title = element_text(size=25),
        axis.title.x = element_text(size=16),
        axis.text.x = element_text(size=8, angle=90),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        strip.text.x = element_text(size = 11)) + 
  # need to have less labels, rename some to empty string
  scale_x_discrete(breaks=waiver(), 
                   labels=c("1999","","","","2003","","", "", "2007", "", "", 
                            "", "2011", "", "", "", "2015", "", "", "", "2019"))

```

## Analysis - 3

> What are the most common/exploited vulnerabilities?

```{r}

top_cwe = cve %>%
  select(cwe_name) %>%
  group_by(cwe_name) %>%
  summarise(n = n(), .groups="drop_last") %>%
  arrange(-n)
  
top = 22

top_n_cwe = top_cwe %>%
  head(top) %>%  
  # add the "Other" row, as the count of all remaining CVEs
  add_row(cwe_name = "Other", 
          n = sum(top_cwe %>% slice(top+1:n()) %>% select(n))) %>% 
  arrange(-n)

# Some names are terribly long (10+ words), hence i manually
# rename some to have a better description of the vulnerability
top_n_cwe$cwe_name = c("Other",
                       "Buffer overflow",
                       "Cross-site Scripting (XSS)",
                       "Improper Input Validation",
                       "Information Exposure",
                       "Access Control",
                       "SQL Injection",
                       "Path Traversal",
                       "Resource Management Errors",
                       "Cryptographic Issues",
                       "Code Injection",
                       "Cross-Site Request Forgery (CSRF)",
                       "Out-of-bounds read",
                       "Improper Authentication",
                       "Improper Access Control",
                       "Numeric Errors",
                       "Use After Free",
                       "Integer Overflow",
                       "NULL pointer Dereference",
                       "Credentials Management",
                       "Out-of-bounds Write",
                       "OS Command Injection",
                       "Race Condition")

top_n_cwe %>%
  # reorder factor based on n (descending). This is only needed for plotting
  mutate(cwe_name = fct_reorder(cwe_name, n)) %>% 
  ggplot(aes(cwe_name, n, fill=n)) +
  coord_flip() +
  guides(fill=FALSE) +
  geom_col() +
  labs(title = "Most common vulnerabilities",
       subtitle = "Based on Common Weaknesses Enumeration (CWE) codes",
       x = "CWE description",
       y = "Number of cases") + 
  theme(plot.title = element_text(size=22),
        axis.title.x = element_text(size=16),
        axis.text.x = element_text(size=11), 
        legend.position = "none", 
        axis.title.y=element_blank(),
        strip.text.x = element_text(size = 12)) +
  scale_fill_gradientn(colours=c("#f9c74f","#90be6d","#4d908e","#577590","#277da1"))
  
```

## Analysis - 4

> How security threats have changed over time?

```{r}

top = 9
rows = 3
cols = 3

cve %>%
  # compute total number of CVEs per year
  group_by(pub_year) %>%
  mutate(tot = n()) %>%
  ungroup() %>%
  select(cwe_name, pub_year, tot) %>%
  # Get the top n-th global CVE
  filter(cwe_name %in% (top_cwe %>% head(top))$cwe_name) %>%
  group_by(cwe_name, pub_year, tot) %>%
  summarise(n=n(), .groups="drop_last") %>%
  mutate(freq = n/tot) %>%
  arrange(-freq) %>%
  mutate(cwe_name =
    case_when(
      str_detect(cwe_name, "Memory Buffer") ~ "Buffer Overflow",
      str_detect(cwe_name, "Cross-site") ~ "Cross-site Scripting (XSS)",
      str_detect(cwe_name, "SQL") ~ "SQL Injection",
      str_detect(cwe_name, "Access Controls") ~ "Access Control",
      str_detect(cwe_name, "Input Validation") ~ "Improper Input Validation",
      str_detect(cwe_name, "Information Exposure") ~ "Information Exposure",
      str_detect(cwe_name, "Cryptographic Issues") ~ "Cryptographic Issues",
      str_detect(cwe_name, "Resource Management Errors") ~ "Resource Management Errors",
      str_detect(cwe_name, "Path Traversal") ~ "Path Traversal")) %>%
ggplot(aes(pub_year, freq, color=cwe_name, group=cwe_name)) + 
  geom_line(size=0.9) +
  labs(title = "Threats changes over the 1999-2019 period",
       x = "Year", 
       y = "Percentage of CVEs") + 
  facet_wrap(c("cwe_name"), ncol = cols, nrow = rows) + 
  theme(plot.title = element_text(size=22),
        axis.title.x = element_text(size=16),
        axis.text.x = element_text(size=8, angle=90),
        panel.grid.major = element_blank(), 
        legend.position = "none",
        strip.text.x = element_text(size = 11)) + 
  # need to have less labels, rename some to empty string
  scale_x_discrete(breaks=waiver(), 
                   labels=c("1999","","","","2003","","", "", "2007", "", "", "", "2011", "", "", "", "2015", "", "", "", "2019")) +
  scale_y_continuous(labels = percent)

```

## Analysis - 5

> Are the attacks getting more complex? Did the attack vector change over years?

```{r}

# Multiple plot function
#
# ggplot objects can be passed in ..., or to plotlist (as a list of ggplot objects)
# - cols:   Number of columns in layout
# - layout: A matrix specifying the layout. If present, 'cols' is ignored.
#
# If the layout is something like matrix(c(1,2,3,3), nrow=2, byrow=TRUE),
# then plot 1 will go in the upper left, 2 will go in the upper right, and
# 3 will go all the way across the bottom.
#
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}


noNA = cve %>%
  # We don't want NAs for this query
  filter(!is.na(access_vector), !is.na(access_complexity)) %>%
  select(pub_year, access_vector, access_complexity) %>%
  # compute total CVEs
  group_by(pub_year) %>%
  mutate(tot = n()) %>%
  ungroup()

attack_vector = noNA %>%
  group_by(pub_year, access_vector, tot) %>%
  summarise(n=n(), .groups="drop_last") %>%
  mutate(freq = n/tot) %>%
  select(pub_year, freq, access_vector)

attack_complexity = noNA %>%
  group_by(pub_year, access_complexity, tot) %>%
  summarise(n=n(), .groups="drop_last") %>%
  mutate(freq = n/tot) %>%
  select(pub_year, freq, access_complexity)

# Generate plots
plot_vector = attack_vector %>%
  mutate(access_vector = if_else(access_vector == "ADJACENT_NETWORK", "ADJACENT NETWORK", as.character(access_vector))) %>%
  rename("Attack Vector" = access_vector) %>%
  ggplot(aes(pub_year, freq)) + 
  geom_line(aes(color=`Attack Vector`, group=`Attack Vector`), size = 0.9) + 
  labs(y = "Frequency") + 
  theme(plot.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=8),
        panel.grid.major = element_blank(), 
        strip.text.x = element_text(size = 11)) + 
  # need to have less labels, rename some to empty string
  scale_x_discrete(breaks=waiver(), 
                   labels=c("1999","","","","2003","","", "", "2007", "", "", 
                            "", "2011", "", "", "", "2015", "", "", "", "2019")) +
  scale_y_continuous(labels = percent)

plot_complexity = attack_complexity %>%
  rename("Attack Complexity" = access_complexity) %>%
ggplot(aes(pub_year, freq)) + 
  geom_line(aes(color=`Attack Complexity`, group=`Attack Complexity`), size = 0.9) + 
   labs(y = "Frequency") + 
  theme(plot.title = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size=8),
        panel.grid.major = element_blank(), 
        strip.text.x = element_text(size = 11)) + 
  # need to have less labels, rename some to empty string
  scale_x_discrete(breaks=waiver(), 
                   labels=c("1999","","","","2003","","", "", "2007", "", "", 
                            "", "2011", "", "", "", "2015", "", "", "", "2019")) +
  scale_y_continuous(labels = percent)

# Plot them together
multiplot(plot_complexity, plot_vector)

```


## Analysis - 6

> What are the most used words in the CVE descriptions?


```{r}
# We use the MITRE dataset for this one, analyzing the description as text
if(using_mitre){
  top = 30
  
  CVEs_description = all_cve %>% 
    select(Code,Description) %>%
    rename(text = Description) %>%
    mutate(text = as.character(text))
  
  tokenized = CVEs_description %>%
    unnest_tokens(word, text)
  
  tidy_CVEs = tokenized %>%
    anti_join(stop_words, by = "word") %>%
    # there are still numbers in the words, remove them with a regex
    filter(!str_detect(word, "^[0-9]*$")) %>%
    group_by(word) %>%
    summarise(n=n(), .groups="drop_last") %>%
    arrange(-n)
  
  tidy_CVEs %>%
    head(top) %>%
    mutate(word = fct_reorder(word, n)) %>%
    ggplot(aes(word, n, fill=n)) +
    geom_col() +
    xlab(NULL) +
    theme_minimal() + 
    scale_fill_viridis(option="D") + 
    scale_y_continuous(labels = number) +
    coord_flip()
  
  ## TODO this graph needs refinements
}

```

## Analysis - 7

> Which vendors have the most CVEs?

```{r}

top = 20

top_cve_vendors = vendors %>%
  group_by(vendor) %>%
  summarise(n=n(), .groups="drop_last") %>%
  arrange(-n) 

top_cve_graph = top_cve_vendors %>%
  head(top) %>%
  mutate(vendor = str_to_sentence(vendor)) %>%
  mutate(vendor = fct_reorder(vendor, n)) %>%
ggplot(aes(vendor, n, fill = n)) +
  geom_col() + 
  guides(fill = FALSE) +
  coord_flip() +
  theme_minimal() + 
  scale_fill_gradient(low="#f7b538",high="#c32f27") +
  labs(title = "Vendors with most CVEs",
       x = "Vendor",
       y = "Number of CVEs") + 
  theme(plot.title = element_text(size=22),
        axis.title.x = element_text(size=12),
        axis.text.x = element_text(size=10), 
        axis.text.y = element_text(size=11),
        legend.position = "none", 
        axis.title.y=element_blank(),
        strip.text.x = element_text(size = 12))


# How much of the CVEs do this top vendors "have", globally?
percentage_cve_graph = top_cve_vendors %>%
  mutate(vendor = ifelse(row_number() <= top, str_c("Top ", top, " vendors"), "Others")) %>%
  group_by(vendor) %>%
  summarise(tot=sum(n), .groups="drop_last") %>%
  mutate(freq = tot/sum(tot)) %>%
ggplot(aes(vendor, freq, fill = vendor)) + 
  geom_col() + 
  scale_y_continuous(labels = percent) + 
  coord_flip() + 
  labs(title="Percentage of CVEs among vendors") + 
  theme_minimal() + 
  theme(plot.title = element_text(size=22),
        axis.text.x = element_text(size=10), 
        axis.text.y = element_text(size=11),
        legend.position = "none", 
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(size = 12),
        aspect.ratio = 0.3)


ggsave(filename="percentage_cve_graph.png", plot=percentage_cve_graph, device="png", path="src/img/")
top_cve_graph
``` 
<div id="double-line">
<p id="inline-left"><img src="img/percentage_cve_graph.jpg" id="percentage_vendor"/></p>
<p id="inline-right">About 40% of the total CVEs are from the vendors above!</p>
</div>

## Analysis - 8

> What are the products with the highest number of CVEs?

```{r}

top = 20

top_products = products %>%
  group_by(vulnerable_product) %>%
  summarise(n=n(), .groups = "drop_last") %>%
  arrange(-n) %>%
  head(top) %>%
  mutate(vulnerable_product = str_to_title(str_replace_all(vulnerable_product, "_", " ")))

top_products %>%
  mutate(vulnerable_product = fct_reorder(vulnerable_product, n)) %>%
ggplot(aes(vulnerable_product, n, fill=n)) +
  geom_col() +
  coord_flip() + 
  theme_minimal() +
  labs(title=str_c("Top ", top, " products with most CVEs")) + 
  theme(plot.title = element_text(size=22),
        axis.text.x = element_text(size=10), 
        axis.text.y = element_text(size=11),
        legend.position = "none", 
        axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_text(size = 12)) +
  scale_fill_gradientn(colors=c("#49B063","#CDB654","#F9C74F",  
                             "#F9B74E","#F9A64D","#F9844A", "#F96347", "#F94144"))
  # scale_fill_gradientn(colours=c("#f9c74f","#90be6d","#4d908e","#577590","#277da1"))

```

## Analysis - 9

> Did the top 9 vendors improve in the years?

```{r}

top = 12

vendors %>%
  filter(vendor %in% (top_cve_vendors %>% head(top))$vendor) %>%
  left_join(cve, by="code") %>%
  group_by(pub_year, vendor) %>%
  summarise(n=n(), .groups="drop_last") %>%
  arrange(-n) %>%
  mutate(vendor = str_to_title(vendor)) %>%
ggplot(aes(pub_year, n)) +
  geom_line(aes(group=vendor, color=vendor)) + 
  facet_wrap(c("vendor")) + 
  labs(title="Number of CVEs in the years for top vendors", x="Year") +
  theme(plot.title = element_text(size=22),
        axis.title.x = element_text(size=16),
        axis.text.x = element_text(size=8, angle=90),
        axis.title.y = element_blank(),
        panel.grid.major = element_blank(), 
        legend.position = "none",
        strip.text.x = element_text(size = 11)) + 
  # need to have less labels, rename some to empty string
  scale_x_discrete(breaks=waiver(), 
                   labels=c("1999","","","","2003","","", "", "2007", "", "", 
                            "", "2011", "", "", "", "2015", "", "", "", "2019"))

```

## CVE Database

```{r, echo = FALSE}
knitr::include_app("http://127.0.0.1:1337")
```


## References

[Kaggle](https://www.kaggle.com/andrewkronser/cve-common-vulnerabilities-and-exposures/data)

[MITRE](https://cve.mitre.org/data/downloads/index.html)

[National Vulnerability Database](https://nvd.nist.gov)

